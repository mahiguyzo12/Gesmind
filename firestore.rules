rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Règle générale : Interdire tout accès par défaut pour plus de sécurité.
    match /{document=**} {
      allow read, write: if false;
    }

    // Les utilisateurs peuvent lire la liste des entreprises pour se connecter,
    // mais ne peuvent pas voir les données sensibles sans être propriétaire.
    // Le document 'stores_registry' doit contenir des métadonnées publiques.
    match /stores_registry/{storeId} {
      allow read: if request.auth != null;
      // La création/mise à jour se fait via une fonction cloud sécurisée (recommandé)
      // ou via la règle ci-dessous si le document contient l'UID du créateur.
      allow create, update: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
    } 

    // Un utilisateur ne peut accéder aux données d'une entreprise (`stores/{storeId}`)
    // que si son UID est présent dans un champ `members` (ou `ownerId`) de ce document.
    // Ici, nous utilisons `ownerId` pour un modèle simple.
    match /stores/{storeId}/{document=**} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }
  }
}
